# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
# Derived from https://github.com/canonical/data-platform-workflows/blob/main/.github/workflows/release_python_package.md
name: Release to PyPI

on:
  push:
    branches:
      - main
      - '[0-9]+.[0-9]+.[0-9]+'

concurrency:
  # Prevent race conditions (if multiple commits have been pushed since the last release)
  group: release-python-package-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tag:
    name: Tag release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Checkout history with git tags & all branches
      - name: Install CLI
        run: pipx install .github/workflows/_cli/
      - name: Create release tag & create branch for last minor version & update antora-main- tag
        id: create-tag
        run: create-version-tag-and-branch --branch-name='${{ github.ref_name }}'
    outputs:
      tag: ${{ steps.create-tag.outputs.tag }}
    permissions:
      contents: write  # Needed to create git tag

  build:
    name: Build package
    needs:
      - tag
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Checkout history with git tags
      - name: Install poetry
        run: |
          pipx install poetry
          pipx inject poetry 'poetry-dynamic-versioning[plugin]'
      - name: Build package
        run: poetry build
      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions  # Keep in sync with `artifact-name` output
          path: dist/
    outputs:
      artifact-name: python-package-distributions

  release-docs:
    name: Release docs to Read the Docs
    needs:
      - tag
    uses: canonical/charm-refresh/.github/workflows/release_docs.yaml@docs-playbook
    secrets:
      readthedocs-token: ${{ secrets.READTHEDOCS_TOKEN }}

  release-trusted-publishing:
    name: Release to PyPI (trusted publishing)
    needs:
      - build
      - release-docs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment: production
    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
    permissions:
      id-token: write  # Needed for PyPI trusted publishing

  release:
    name: Create GitHub release
    needs:
      - tag
      - release-trusted-publishing
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Create GitHub release
        # GitHub CLI docs on `--latest` are incorrect; default is to always mark release as latest
        # https://github.com/cli/cli/blob/85d6766c621a9d67e0d353a12bb388c40ceca2a1/pkg/cmd/release/create/create.go#L217
        # https://github.com/cli/cli/blob/85d6766c621a9d67e0d353a12bb388c40ceca2a1/pkg/cmdutil/flags.go#L23
        # (default is not automatic, as written in the CLI docs)
        # The actual behavior matches the default value for `make_latest` in the GitHub API:
        # https://docs.github.com/en/rest/releases/releases?apiVersion=2022-11-28#create-a-release
        # Furthermore, the automatic behavior (when setting `make_latest` to `legacy` and calling
        # the API directly), from testing, appears to only work with semantic versionsâ€”otherwise
        # the ordering appears to be alphabetical (so it sees "v1.0.0.2" as a newer version than
        # "v1.0.0.10")
        # Instead, determine if this is the latest version by whether this branch is the default
        # branch
        run: |
          # Check if this branch is the default branch for the GitHub repository
          if [[ '${{ github.ref }}' == 'refs/heads/${{ github.event.repository.default_branch }}' ]]
          then
            gh release --repo '${{ github.repository }}' create '${{ needs.tag.outputs.tag }}' --verify-tag --generate-notes --latest
          else
            gh release --repo '${{ github.repository }}' create '${{ needs.tag.outputs.tag }}' --verify-tag --generate-notes --latest=false
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write  # Needed to create GitHub release
